---
title: "Cr√©er un assistant de code personnel avec {ragnar} et Zotero"
description: "Comment entra√Æner un mod√®le LLM open-source sur des documents pour se faire un assistant de code sp√©cialis√© dans son domaine d'expertise"
format: html
author: "F√©lix Marchais"
date: "2025-10-14"
categories:
  - R
  - IA
  - LLM
image: "/pages/articles/images/ragnar_logo.png"
execute: 
  eval: false 
  echo: true
  message: false
  warning: false
---

Etant plut√¥t du genre √† √™tre dans les derniers √† suivre une tendance, mon utilisation des LLM √©tait jusqu'√† r√©cemment limit√©e √† poser des questions √† chat-GPT ou GitHub Copilot. Il y a environ deux semaines, en discutant avec un ami dont le m√©tier est justement d'accompagner les entreprises dans leur passage √† l'IA, celui-ci m'a expliqu√© les diff√©rents mots-cl√©s du domaine : "MCP", "Agent", "Contexte" et surtout : **la "RAG"** (Retrieval-Augmented Generation), ou "G√©n√©ration Augment√©e par R√©cup√©ration".

La RAG, c'est faire lire des documents √† un LLM pour qu'il puisse les utiliser dans ses r√©ponse. Cela revient √† ajouter de nouvelles donn√©es (que l'on estime fiables) √† sa base d'entra√Ænement et permet de le sp√©cialiser dans un domaine.

Ca tombe bien ! Depuis que j'ai commenc√© √† coder, j'utilise Zotero pour indexer des tonnes de guides et d'articles sur R. L'id√©e m'est imm√©diatement venue : cr√©er un assistant de code sp√©cialis√© en R et en donn√©es de sant√©.

# Zotero, c'est quoi ?

[Zotero](https://www.zotero.org), c'est un logiciel gratuit qui permet de se cr√©er une biblioth√®que compos√©e de diff√©rentes pages Web ou documents. En le t√©l√©chargeant, on ajoute une extension √† son navigateur, qui permet d'ajouter le lien de la page visit√©e √† sa biblioth√®que, et si la page affiche un document PDF, de le t√©l√©charger.

Ma biblioth√®que Zotero contient aujourd'hui pr√®s d'un millier de documents : des liens vers des livres comme "R for Data Science" d'Hadley Wickham (un classique), des articles de blog, ou des *cheatsheets* (antis√®ches) r√©sumant le fonctionnement des principaux packages du `Tidyverse`, que l'on peut retrouver par exemple [ici](https://dplyr.tidyverse.org/). Cette biblioth√®que est une mine d'or pour moi car elle me permet de retrouver facilement la documentation que j'ai pu parcourir, et sera parfaite pour entra√Æner notre assistant IA.

![Extrait d'une biblioth√®que Zotero. Source : https://www.zotero.org/?lang=fr_fr](images/zotero.png)

# Ragnar

[Ragnar](https://ragnar.tidyverse.org/) est un package tout r√©cent qui permet de cr√©er un "knowledge store" pour un LLM. Il accepte de nombreux formats : URLs, fichiers textes, PDF, PowerPoint, Word, Excel, images, audio, HTML, CSV, JSON, XML, fichiers ZIP et m√™me des vid√©os YouTube.

Tous les documents ing√©r√©s sont convertis en markdown et int√©gr√©s √† un store (une base de donn√©es DuckDB) que l'on mettra √† disposition du LLM.

Ragnar permet seulement de cr√©er le store et de l'utiliser. Il faudra ensuite utiliser [{ellmer}](https://ellmer.tidyverse.org/) pour discuter avec notre assistant.

# Quel mod√®le choisir ?

`Ragnar` fonctionne avec diff√©rents fournisseurs d'IA, dont OpenAI (ChatGPT), mais notre objectif est ici de se cr√©er un assistant local et gratuit, on se tournera donc plut√¥t vers [Ollama.](https://ollama.com/) \n

Ollama est une plateforme qui met √† disposition des mod√®les de LLM gratuits et t√©l√©chargeables en local. Ces mod√®les sont √©videmment moins puissants que ChatGPT ou Claude, mais ce n'est pas tr√®s grave puisque l'on va entra√Æner le notre sur des donn√©es qui seront pertinentes pour nous.

::: callout-caution
Tous les mod√®les pr√©sents sur Ollama ne sont pas compatibles avec la RAG, il faut choisir une variante "-instruct". Pour cela, une fois votre mod√®le choisi, cliquez sur "View all" pour voir toutes les variantes du mod√®les, et choisissez un "-instruct".

A noter que tous les mod√®les "-instruct" ne sont pas n√©c√©ssairement compatibles. Il vous faudra tester diff√©rents mod√®les si vous souhaitez un autre que celui dans cet exemple.

(Si vous en trouvez un tr√®s bon, n'h√©sitez pas √† me contacter pour m'en faire part !)

![](images/ollama.png)
:::

# Ellmer

`Ellmer` est un package R du `Tidyverse` et d√©velopp√© par Hadley Wickham (encore lui), qui permet de discuter avec diff√©rents LLMs depuis R. On utilisera sa fonction `char_ollama()` pour discuter avec notre assistant.

# Cr√©√©r son assistant

Maintenant que l'on a tous les ingr√©dients, on peut commencer √† se mettre au travail.

## R√©cup√©rer les documents

Tout d'abord, commen√ßons par extraire notre biblioth√®que Zotero. On aura besoin des PDFs d√©j√† r√©cup√©r√©s et des liens vers les documents enregistr√©s. \n

Pour les PDFs, dans Zotero allez dans Fichier \> Exporter la biblioth√®que \> Format : "Zotero RDF" et cochez "Exporter les fichiers". Vous obtiendrez ainsi un dossier "Ma biblioth√®que", qui contient un sous-dossier "files", qui contient les documents, et un fichier "Ma biblioth√®que.rdf" que nous n'utiliserons pas.

Pour obtenir les URLs, exportez simplement votre biblioth√®que au format.csv.

```{r setup}
library(readr)
library(dplyr)
library(glue)
library(ragnar)
library(rollama)

# R√©cup√©rer tous les chemins des fichiers PDF dans le dossier "files"
pdf_paths <- list.files(
  path = "D:/Ma biblioth√®que/files/",
   pattern = "\\.pdf", 
   full.names = TRUE, 
   recursive = TRUE)

# R√©cup√©rer les liens dans le fichier .csv
zotero_csv <- read_csv2("D:/ma_biblio_csv.csv") %>%
  filter(!is.na(Url) | !is.na(`Link Attachments`) )

zotero_urls <- zotero_csv %>% 
  select(Url, `Link Attachments`) %>%
  unlist() %>%
  na.omit() %>%
  unique()

# Ragnar permet aussi de r√©cup√©rer les liens pr√©sents sur une page.
# On peut ainsir r√©cup√©rer toutes les pages d'une documentation 
# √† partir du lien principal
zotero_external_links <- c()
for(link in zotero_urls){
  tryCatch({
    doc <- ragnar_find_links(link, depth = 2)
    zotero_external_links <- append(zotero_external_links, doc)
  })
}
  
# On combine le tout pour obtenir un seul vecteur
full_links <- c(pdf_paths, zotero_urls, zotero_external_links) %>% 
  unique()
```

::: callout-caution
Ma biblioth√®que compte aujourd'hui pr√®s d'un millier de documents, et en consid√©rant une moyenne d'une minute par document, il m'a fallu plus de 30 heures pour tout ing√©rer. Pour faire cette exp√©rience de votre c√¥t√©, vous pouvez tester avec seulement la documentation du package {rhino} en rempla√ßant `full_links` par ce lien : "https://appsilon.github.io/rhino/articles/tutorial/create-your-first-rhino-app.html"
:::

## Cr√©er le store

Le store est une base DuckDB qui contiendra nos documents, d√©coup√©s en *chunks*, pour permettre √† l'assistant d'y acc√©der.

```{r store}
# Si on ne met que le nom, enregistr√© sous C:/user/votre_nom/ (sur Windows)
store_location <- "zotero_ragnar.duckdb"

# Cr√©er le store
store <- ragnar_store_create(
  store_location,
  embed = \(x) ragnar::embed_ollama(x, model = "llama3.2:3b-instruct-q4_K_M"),
  overwrite = TRUE
)

# S'y connecter
store <- ragnar_store_connect("zotero_ragnar.duckdb", read_only = FALSE)
```

## Ing√©rer les documents dans le store

Maintenant que le store est cr√©√©, on va enregistrer nos documents via une boucle. `read_as_markdown` permet de transformer le document (URL, PDF ou autre) en markdown, puis `markdown_chunk` permet de le d√©couper en chunk pour que le LLM puisse l'exploiter.

::: callout-caution
Lorsqu'une URL est fournie, {ragnar} va scraper la page. Certains sites n'autorisent pas le webscraping (et c'est leur droit) et vous renverront une erreur 403. Dans ce cas, il n'y a pas grand chose √† faire. On ajoutera un `tryCatch()` √† notre boucle pour ne pas la casser si une erreur est renvoy√©e.
:::

```{r}
for (path in full_links) {
  tryCatch({
    chunks <- path |>
      read_as_markdown() |>
      markdown_chunk()
    
    ragnar_store_insert(store, chunks)
    # pour visualiser la progression
    print(which(path == full_links), "/", length(full_links))

  }, error = function(e) {
    cat("Error processing", path, ":", e$message, "\n")
    # Optionally log the error or take other action
  })
}

# Indispensable pour rendre notre store exploitable
ragnar_store_build_index(store)

# On peut ensuite v√©rifier l'int√©gration des documents avec
ragnar_store_inspect(store)

```

## Pr√©parer l'assistant

On va tester notre assistant en lui demander de nous aider √† utiliser le framework {rhino}, d√©velopp√© par [Appsilon](https://www.appsilon.com/rhinoverse/rhino) pour aider √† cr√©er des applications R/Shiny robustes.

```{r}
# Notre Query
text <- "How to use the {Rhino} R package to create a Shiny app ? Be concise"


# On peut visualiser les chunks les plus pertinents pour notre question avec
relevant_chunks <- ragnar_retrieve(store, text)


# D√©finir un prompt de pr√©paration
# il sera possible d'enregistrer ce prompt dans un .Rprofile pour ne pas avoir √† le r√©p√©ter
system_prompt <- stringr::str_squish(
  "
  You are an expert R programmer and mentor. You are concise.

  Before responding, retrieve relevant material from the knowledge store. Quote or
  paraphrase passages, clearly marking your own words versus the source. Provide a
  working link for every source cited, as well as any additional relevant links.
  Do not answer unless you have retrieved and cited a source.
  "
)
```

## Discuter avec l'assistant

On va tout d'abord tester notre assistant, pour voir s'il connait le package {rhino} :

```{r}

chat <- ellmer::chat_ollama(
  system_prompt,
  model = "llama3.2:3b-instruct-q4_K_M"
)

chat$chat(text)


# I'm unable to retrieve accurate information regarding the "{Rhino}" R package without more context. However, I can provide general guidance on creating a Shiny app using the Shiny package in R.
# 
# To start building a Shiny app:
# 
# 1.  Install and load the `shiny` package:
# 
# ``` r
# install.packages("shiny")
# library(shiny)
# ....
```

Pour le moment, il est incapable de r√©pondre. \n

On va maintenant lui donner acc√®s au store :

```{r}
ragnar_register_tool_retrieve(chat, store)
chat$chat(text)



# ‚óØ \[tool call\] rag_retrieve_from_store_003(text = " installing and loading shiny package") ‚óè #\> \[{"origin":"https://appsilon.github.io/rhino/articles/tutorial/create-your-first-rhino-app.html","doc_id":1,"ch‚Ä¶ To create a Shiny app using the Rhino package, follow these steps:
# 
# 1.  Install Rhino: `package::install("rhino")`
# 2.  Create an initial Rhino application: `rhino::init("RhinoApplication")`
# 
# Install necessary packages:
# 
# ``` r
# # In R console
# rhino::pkg_install(c(
#   "dplyr",
#   "echarts4r",
#   "htmlwidgets",
#   "reactable",
#   "tidyr"
# ))
# ```
# .....
```

Victoire ! Notre assistant conna√Æt d√©sormais {rhino} et peut nous accompagner pour le d√©veloppement d'applications Shiny plus pouss√©es !

Il ne reste plus qu'√† continuer avec tous les documents de notre biblioth√®que pour d√©velopper les connaissances de notre assistant.

Notre mod√®le √©tant install√© en local, l'assistant fonctionne m√™me sans connection internet, de fa√ßon illimit√©e et gratuite. Si le mod√®le n'est pas assez performant pour vous, vous pouvez parcourir la liste de mod√®les Ollama pour en trouver un plus adapt√© √† votre usage.

::: caution-tip
-   Pour ajouter de nouveaux documents, on peut cr√©er une nouvelle boucle avec `ragnar_store_insert` et `ragnar_store_build_index()`. On passera simplement l'√©tape `ragnar_store_create()` pour passer directement √† `ragnar_store_connect()`
-   Pour que l'assistant soit pr√™t d√®s le lancement de notre IDE, on peut enregistrer les √©tapes suivantes dans un .Rprofile
    -   `ragnar_store_connect()`
    -   Le `system_prompt`
    -   La cr√©ation de `chat` avec `ellmer::chat_ollama()`

:::

```{r include = FALSE}
# Post linkedin :

# version chatgpt
"Et si vous pouviez cr√©er votre propre assistant de code IA, sp√©cialis√© dans votre domaine, 100% gratuit, local et open-source ?

C‚Äôest exactement ce que j‚Äôai fait la semaine derni√®re. En partant d‚Äôune id√©e simple : utiliser la RAG (Retrieval-Augmented Generation) pour alimenter un mod√®le LLM avec ma propre base de connaissances sur R, issue de ma biblioth√®que Zotero riche de plus de 1 000 ressources.

Gr√¢ce √† Ollama, j‚Äôai pu faire tourner des mod√®les open-source localement, sans d√©pendre d‚ÄôAPI cloud.

R√©sultat : un assistant IA qui conna√Æt R sur le bout des doigts, fonctionne sans connexion, et ne co√ªte rien.

Dans l‚Äôarticle ci-dessous, je d√©taille toute la d√©marche, le setup, les outils, et je partage le code pour que vous puissiez faire la m√™me chose chez vous üëá
üîó [Lien vers l'article]"







```
